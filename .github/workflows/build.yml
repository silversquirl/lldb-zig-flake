name: Build
on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CACHE_URL: s3://nix-squirl-dev?region=us-east-005&endpoint=s3.us-east-005.backblazeb2.com
  PACKAGES: .#lldb-zig-full .#lldb-zig

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          swap-size-mb: 4096
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true
          # nix runs builds in /tmp/nix-build-*
          build-mount-path: /tmp

      - uses: actions/checkout@v4
      - uses: nixbuild/nix-quick-install-action@v31

      - name: Report disk usage pre-build
        run: df -h

      - name: Build packages
        working-directory: ci
        run: nix build --print-build-logs $PACKAGES

      - name: Report disk usage post-build
        run: df -h

      - name: Sign packages
        working-directory: ci
        run: |
          echo "$NIX_SIGNING_KEY" >signing-key
          nix store sign --verbose --key-file signing-key $PACKAGES
          rm signing-key
        env:
          NIX_SIGNING_KEY: ${{ secrets.NIX_SIGNING_KEY }}

      - name: Upload to binary cache
        working-directory: ci
        run: nix copy --verbose --to "$CACHE_URL" $PACKAGES
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.B2_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.B2_SECRET_KEY }}

